on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: new_app
  AZURE_WEBAPP_PACKAGE_PATH: './node-project/new_app'
  NODE_VERSION: '18.18.0'

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Print current working directory
      run: pwd

    - name: List files in the working directory
      run: ls -R

    - name: Install dependencies
      run: npm install
      working-directory: ./node-project

    - name: Verify node-project directory
      run: ls -R ./node-project

    - name: Verify new_app directory
      run: ls -R ./node-project/new_app || echo "Directory ./node-project/new_app does not exist."

    - name: Upload artifact for deployment job
      uses: actions/upload-artifact@v3
      with:
        name: node-app
        path: ./node-project/new_app

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions: 
      contents: none
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
    - name: Download artifact from build job
      uses: actions/download-artifact@v3
      with:
        name: node-app

    - name: Deploy to Azure WebApp
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    - name: Download a Build Artifact
      uses: actions/download-artifact@v4.1.8
      with:
    # Name of the artifact to download. If unspecified, all artifacts for the run are downloaded.
        name: # optional
    # Destination path. Supports basic tilde expansion. Defaults to $GITHUB_WORKSPACE
        path: # optional
    # A glob pattern matching the artifacts that should be downloaded. Ignored if name is specified.
        pattern: # optional
    # When multiple artifacts are matched, this changes the behavior of the destination directories. If true, the downloaded artifacts will be in the same directory specified by path. If false, the downloaded artifacts will be extracted into individual named directories within the specified path.
        merge-multiple: # optional, default is false
    # The GitHub token used to authenticate with the GitHub API. This is required when downloading artifacts from a different repository or from a different workflow run. If this is not specified, the action will attempt to download artifacts from the current repository and the current workflow run.
        github-token: # optional
    # The repository owner and the repository name joined together by "/". If github-token is specified, this is the repository that artifacts will be downloaded from.
        repository: # optional, default is ${{ github.repository }}
    # The id of the workflow run where the desired download artifact was uploaded from. If github-token is specified, this is the run that artifacts will be downloaded from.
        run-id: # optional, default is ${{ github.run_id }}
          
